/*
  ___ ___     _____     _________  ___ ___     _____    _______   ._.
 /   |   \   /  _  \   /   _____/ /   |   \   /  _  \   \      \  | |
/    ~    \ /  /_\  \  \_____  \ /    ~    \ /  /_\  \  /   |   \ | |
\    Y    //    |    \ /        \\    Y    //    |    \/    |    \ \|
 \___|_  / \____|__  //_______  / \___|_  / \____|__  /\____|__  / __
       \/          \/         \/        \/          \/         \/  \/

*/
/* COPYRIGHT HASHAN PUNCHIHEWA (2013) */ (function(){var module={exports:window};var exports=module.exports;var cookie,crc32,events,formidable,fs,http,path,signature,stream,url,util,mime,mongodb;var FS={};var TS={};if(typeof require!=="undefined"){cookie=require("cookie"),crc32=require("buffer-crc32"),events=require("events"),formidable=require("formidable"),fs=require("fs"),http=require("http"),path=require("path"),signature=require("cookie-signature"),stream=require("stream"),url=require("url"),util=require("util"),mime=require("mime");}
var extend=(typeof util!=="undefined"&&util._extend)||function(extendee,extender){var obj={};for(var i in extender){extendee[i]=extender[i];}};var inherits=function(constructor,superConstructor){constructor.prototype=new superConstructor();constructor._super=superConstructor;constructor.prototype.__super__=superConstructor;};var instanceOf=function(object,klass){return(object.constructor===klass||object.constructor.prototype instanceof klass||((klass===stream.Writable||klass.prototype instanceof stream.Writable)&&instanceOf(object,stream.Duplex)));};var nextTick=(typeof process!=="undefined"&&process.nextTick)||root.setImmediate||function(fn){setTimeout(fn,0);};var once=function(cb){var hasBeenRun=false,result;return function(){if(!hasBeenRun){result=cb.apply(null,Array.prototype.slice.call(arguments));hasBeenRun=true;}
return result;};};var either=function(a,b){if(CS.isFunction(a)&&CS.isFunction(b)){return function(){return a.apply(null,arguments)||b.apply(null,arguments);};}else{return a||b;}};var CS={};extend(CS,{each:function(list,iterator){if(stream&&stream.Stream&&list instanceof stream.Stream){var Stream=new stream.Transfrom();Stream._transform=function(chunk,encoding,done){iterator(chunk);this.push(chunk);done();};return list.pipe(Stream);}else if(mongodb&&mongodb.Cursor&&list instanceof mongodb.Cursor){CS.each(list.stream());}else if(list instanceof Array&&list.forEach){list.forEach(iterator);}else if(list instanceof Array){for(var i=0;i<list.length;i++)iterator(list[i],i);}else{for(var c in list)iterator(c,list[c]);}},map:function(list,iterator){if(list instanceof stream.Stream){var Stream=new stream.Transform();Stream._transform=function(chunk,encoding,done){this.push(iterator(chunk));done();};return list.pipe(Stream);}else if(mongodb&&mongodb.Cursor&&list instanceof mongodb.Cursor){CS.each(list.stream());}else if(list instanceof Array&&list.map){return list.map(iterator);}else if(list instanceof Array){var res=[];for(var i=0;i<list.length;i++)res[i]=iterator(list[i],i);return res;}},filter:function(list,iterator){if(list instanceof stream.Stream){var Stream=new stream.Transform();Stream._transform=function(chunk,encdoing,done){if(iterator(chunk))this.push(chunk);done();};return list.pipe(Stream);}else if(mongodb&&mongodb.Cursor&&list instanceof mongodb.Cursor){CS.each(list.stream());}else if(list instanceof Array&&list.filter){return list.filter(iterator);}else if(list instanceof Array){var res=[];for(var i=0;i<list.length;i++){if(iterator(list[i])){res.push(list[i]);}
return res;}}}});extend(CS,{join:function(data,delimeter){return data.join(delimeter||',');},flatten:function(list){var ret=[];CS.each(list,function(val){if(CS.isArray(val))ret=ret.concat(CS.flatten(val));else ret.push(val);});return ret;},last:function(list){return list[list.length-1];}});extend(CS,{merge:function(extendee,extender){var obj={};for(var i in extendee){obj[i]=extendee[i];}
for(var i in extender){obj[i]=extender[i];}
return obj;},keys:Object.keys||function(obj){var array=[];for(var i in obj){array.push(i);}
return array;},values:function(obj){var array=[];for(var i in obj){array.push(obj[i]);}
return array;},pairs:function(obj){var array=[];for(var i in obj){array.push([i,obj[i]]);}
return array;},pick:function(obj){var args=Array.prototype.slice.call(arguments).slice(1);var objToReturn={};for(var i=0;i<args.length;i++){objToReturn[args[i]]=obj[args[i]];}
return objToReturn;},has:function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key);},object:function(keys,values){var ret={};for(var i=0;i<keys.length&&i<values.length;i++){ret[keys[i]]=values[i];}
return ret;}});extend(CS,{toUpperCase:function(str){return str.toUpperCase();},toString:function(str){return str.toString();},tail:function(str,lines){lines=lines||10;lines=(lines>str.length?str.length:lines);var val=str.split("\n");return val.slice(val.length-lines-1).join("\n");},trim:function(str){return str.replace(/^\s+|\s+$/g,'');}});extend(CS,{isCanvas:function(val){return val.tagName==="CANVAS";},isElement:function(val){return(typeof HTMLElement==="object"?val instanceof HTMLElement:val&&typeof val==="object"&&val!==null&&val.nodeType===1&&typeof val.nodeName==="string");},isStream:function(val){return val instanceof stream.Stream;},isDOMTokenList:function(val){return val instanceof DOMTokenList;}});CS.each("Arguments Array Boolean Blob Buffer Date Error File Function Generator Number Object RegExp String Symbol Undefined".split(" "),function(type){CS["is"+type]=(root[type]&&root[type]["is"+type])||(util&&util["is"+type])||function(val){return Object.prototype.toString.call(val)===("[object "+type+"]");};});CS.isNullOrUndefined=either(CS.isNull,CS.isUndefined);extend(CS,{range:function(start,stop,step){if(stop===undefined){stop=start;start=1;}
if(step===undefined)step=1;var x=start||1,res=[];while(x<=stop){res.push(x);x+=step;}
return res;}});CS.Events=(events&&events.EventEmitter)||function(){this._events={};};CS.Events.prototype.addListener=CS.Events.prototype.on=CS.Events.prototype.addListener||function(eventName,cb){if(!this._events[eventName])this._events[eventName]=[];this._events[eventName].push(cb);};CS.Events.prototype.once=CS.Events.prototype.once||function(eventName,cb){this.addListener(eventName,once(cb));};CS.Events.prototype.removeAllListeners=CS.Events.prototype.removeAllListeners||function(eventName){delete this._events[eventName];};CS.Events.prototype.listeners=CS.Events.prototype.listeners||function(eventName){return this._events[eventName];};CS.Events.prototype.totalListeners=function(eventName){return this._events[eventName].length;};CS.Events.prototype.emit=CS.Events.prototype.emit||function(eventName){if(this._events[eventName]){this._events[eventName].apply(this,Array.prototype.slice.call(arguments).slice(1));}};CS.Events.extend=function(options){var parent=this;var child;if(options&&CS.has(options,'constructor')){child=function(){options.constructor.apply(this,arguments);};}else{child=function(){parent.apply(this,arguments);};}
inherits(child,parent);extend(child.prototype,options);child.extend=parent.extend;if(parent.listen){child.listen=parent.listen;}
return child;};CS.Enum=function(options){if(CS.isObject(options)){var count=0;for(var i in options){options[i]._id=count;this[i]=options[i];if(CS.isObject(this[i]))Object.freeze(this[i]);count++;}}else{for(var i=0;i<arguments.length;i++){this[arguments[i]]=i;}}
Object.freeze(this);};if(stream===undefined){var stream={};stream.Stream=CS.Events.extend();function ReadableState(options,stream){options=options||{};var hwm=options.highWaterMark;var defaultHwm=options.objectMode?16:16*1024;this.highWaterMark=(hwm||hwm===0)?hwm:defaultHwm;this.highWaterMark=~~this.highWaterMark;this.buffer=[];this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=null;this.ended=false;this.endEmitted=false;this.reading=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.objectMode=!!options.objectMode;this.defaultEncoding=options.defaultEncoding||'utf8';this.ranOut=false;this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(options.encoding){if(!StringDecoder)
StringDecoder=require('string_decoder').StringDecoder;this.decoder=new StringDecoder(options.encoding);this.encoding=options.encoding;}}
stream.Readable=stream.Stream.extend({constructor:function(options){this._readableState=new ReadableState(options,this);this.readable=true;this.__super__();},push:function(chunk,encoding){var state=this._readableState;if(CS.isString(chunk)&&!state.objectMode){encoding=encoding||state.defaultEncoding;if(encoding!==state.encoding){chunk=new(Buffer||Blob)(chunk,encoding);encoding='';}}
return readableAddChunk(this,state,chunk,encoding,false);},unshift:function(chunk){var state=this._readableState;if(CS.isString(chunk)&&!state.objectMode){encoding=encoding||state.defaultEncoding;if(encoding!==state.encoding){chunk=new((Buffer||Blob)(chunk,encoding));encoding='';}}
return readableAddChunk(this,state,chunk,'',true);},read:function(n){var state=this._readableState;var nOrig=n;if(!CS.isNumber(n)||n>0)state.emittedReadable=false;if(n===0&&state.needReadable&&(state.length>=state.highWaterMark||state.ended)){if(state.length===0&&state.ended)endReadable(this);else emitReadable(this);return null;}
n=howMuchToRead(n,state);if(n===0&&state.ended){if(state.length===0)endReadable(this);return null;}
var doRead=state.needReadable;if(state.length===0||state.length-n<state.highWaterMark){doRead=true;debug('length less than watermark',doRead);}
if(state.ended||state.reading){doRead=false;debug('reading or ended',doRead);}
if(doRead){state.reading=true;state.sync=true;if(state.length===0)state.needReadable=true;this._read(state.highWaterMark);state.sync=false;}
if(doRead&&!state.reading)n=howMuchToRead(nOrig,state);var ret;if(n>0)ret=fromList(n,state);else ret=null;if(CS.isNull(ret)){state.needReadable=true;n=0;}
state.length-=n;if(state.length===0&&!state.ended)
state.needReadable=true;if(nOrig!==n&&state.ended&&state.length===0)
endReadable(this);if(!CS.isNull(ret))
this.emit('data',ret);return ret;},pipe:function(dest,pipeOpts){var src=this;var state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest);break;}
state.pipesCount+=1;var doEnd=(!pipeOpts||pipeOpts.end!==false)&&dest!==process.stdout&&dest!==process.stderr;var endFn=doEnd?onend:cleanup;if(state.endEmitted)nextTick(endFn);else src.once('end',endFn);dest.on('unpipe',onunpipe);function onunpipe(readable){debug('onunpipe');if(readable===src){cleanup();}}
function onend(){debug('onend');dest.end();}
var ondrain=pipeOnDrain(src);dest.on('drain',ondrain);function cleanup(){debug('cleanup');dest.removeListener('close',onclose);dest.removeListener('finish',onfinish);dest.removeListener('drain',ondrain);dest.removeListener('error',onerror);dest.removeListener('unpipe',onunpipe);src.removeListener('end',onend);src.removeListener('end',cleanup);src.removeListener('data',ondata);if(state.awaitDrain&&(!dest._writableState||dest._writableState.needDrain))
ondrain();}
src.on('data',ondata);function ondata(chunk){debug('ondata');var ret=dest.write(chunk);if(false===ret){debug('false write response, pause',src._readableState.awaitDrain);src._readableState.awaitDrain++;src.pause();}}
function onerror(er){debug('onerror',er);unpipe();dest.removeListener('error',onerror);if(EE.listenerCount(dest,'error')===0)
dest.emit('error',er);}
if(!dest._events||!dest._events.error)
dest.on('error',onerror);else if(Array.isArray(dest._events.error))
dest._events.error.unshift(onerror);else
dest._events.error=[onerror,dest._events.error];function onclose(){dest.removeListener('finish',onfinish);unpipe();}
dest.once('close',onclose);function onfinish(){debug('onfinish');dest.removeListener('close',onclose);unpipe();}
dest.once('finish',onfinish);function unpipe(){debug('unpipe');src.unpipe(dest);}
dest.emit('pipe',src);if(!state.flowing){debug('pipe resume');src.resume();}
return dest;},_read:function(){this.emit('error',new Error('not implemented'));},setEncoding:function(enc){if(!StringDecoder)StringDecoder=require('string_decoder').StringDecoder;this._readableState.decoder=new StringDecoder(enc);this._readableState.encoding=enc;return this;}});function readableAddChunk(stream,state,chunk,encoding,addToFront){var er=chunkInvalid(state,chunk);if(er){stream.emit('error',er);}else if(CS.isNullOrUndefined(chunk)){state.reading=false;if(!state.ended)
onEofChunk(stream,state);}else if(state.objectMode||chunk&&chunk.length>0){if(state.ended&&!addToFront){var e=new Error('stream.push() after EOF');stream.emit('error',e);}else if(state.endEmitted&&addToFront){var e=new Error('stream.unshift() after end event');stream.emit('error',e);}else{if(state.decoder&&!addToFront&&!encoding)
chunk=state.decoder.write(chunk);if(!addToFront)
state.reading=false;if(state.flowing&&state.length===0&&!state.sync){stream.emit('data',chunk);stream.read(0);}else{state.length+=state.objectMode?1:chunk.length;if(addToFront)
state.buffer.unshift(chunk);else
state.buffer.push(chunk);if(state.needReadable)
emitReadable(stream);}
maybeReadMore(stream,state);}}else if(!addToFront){state.reading=false;}
return needMoreData(state);}
function needMoreData(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||state.length===0);}
var MAX_HWM=0x800000;function roundUpToNextPowerOf2(n){if(n>=MAX_HWM){n=MAX_HWM;}else{n--;for(var p=1;p<32;p<<=1)n|=n>>p;n++;}
return n;}
function howMuchToRead(n,state){if(state.length===0&&state.ended)
return 0;if(state.objectMode)
return n===0?0:1;if(isNaN(n)||util.isNull(n)){if(state.flowing&&state.buffer.length)
return state.buffer[0].length;else
return state.length;}
if(n<=0)
return 0;if(n>state.highWaterMark)
state.highWaterMark=roundUpToNextPowerOf2(n);if(n>state.length){if(!state.ended){state.needReadable=true;return 0;}else
return state.length;}
return n;}
function chunkInvalid(state,chunk){var er=null;if(!util.isBuffer(chunk)&&!util.isString(chunk)&&!util.isNullOrUndefined(chunk)&&!state.objectMode&&!er){er=new TypeError('Invalid non-string/buffer chunk');}
return er;}
function onEofChunk(stream,state){if(state.decoder&&!state.ended){var chunk=state.decoder.end();if(chunk&&chunk.length){state.buffer.push(chunk);state.length+=state.objectMode?1:chunk.length;}}
state.ended=true;emitReadable(stream);}
function emitReadable(stream){var state=stream._readableState;state.needReadable=false;if(!state.emittedReadable){debug('emitReadable',state.flowing);state.emittedReadable=true;if(state.sync){nextTick(function(){emitReadable_(stream);});}else{emitReadable_(stream);}}}
function emitReadable_(stream){stream.emit('readable');flow(stream);}
function maybeReadMore(stream,state){if(!state.readingMore){state.readingMore=true;nextTick(function(){maybeReadMore_(stream,state);});}}
function maybeReadMore_(stream,state){var len=state.length;while(!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark){debug('maybeReadMore read 0');stream.read(0);if(len===state.length)
break;else
len=state.length;}
state.readingMore=false;}
function WriteReq(chunk,encoding,cb){this.chunk=chunk;this.encoding=encoding;this.callback=cb;}
function WritableState(options,stream){options=options||{};var hwm=options.highWaterMark;var defaultHwm=options.objectMode?16:16*1024;this.highWaterMark=(hwm||hwm===0)?hwm:defaultHwm;this.objectMode=!!options.objectMode;this.highWaterMark=~~this.highWaterMark;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;var noDecode=options.decodeStrings===false;this.decodeStrings=!noDecode;this.defaultEncoding=options.defaultEncoding||'utf8';this.length=0;this.writing=false;this.corked=0;this.sync=true;this.bufferProcessing=false;this.onwrite=function(er){onwrite(stream,er);};this.writecb=null;this.writelen=0;this.buffer=[];this.pendingcb=0;this.prefinished=false;}
stream.Writable=stream.Stream.extend({constructor:function(options){this._writableState=new WritableState(options,this);},write:function(chunk,encoding,cb){var state=this._writableState;var ret=false;if(CS.isFunction(encoding)){cb=encoding;encoding=null;}
if(CS.isBlob(chunk)||CS.isBuffer(chunk))encoding='buffer';else if(!encoding)encoding=state.defaultEncoding;if(!CS.isFunction(cb))cb=function(){};if(state.ended){writeAfterEnd(this,state,cb);}else if(validChunk(this,state,chunk,cb)){state.pendingcb++;ret=writeOrBuffer(this,state,chunk,encoding,cb);}
return ret;}});function validChunk(stream,state,chunk,cb){var valid=true;if(!CS.isBuffer(chunk)&&!CS.isString(chunk)&&!CS.isNullOrUndefined(chunk)&&!state.objectMode){var er=new TypeError('Invalid non-string/buffer chunk');stream.emit('error',er);nextTick(function(){cb(er);});valid=false;}
return valid;}
function writeOrBuffer(stream,state,chunk,encoding,cb){chunk=decodeChunk(state,chunk,encoding);if(CS.isBlob(chunk)||CS.isBuffer(chunk))encoding='buffer';var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;state.needDrain=!ret;if(state.writing||state.corked)
state.buffer.push(new WriteReq(chunk,encoding,cb));else
doWrite(stream,state,false,len,chunk,encoding,cb);return ret;}
function decodeChunk(state,chunk,encoding){if(!state.objectMode&&state.decodeStrings!==false&&util.isString(chunk)){chunk=new Buffer(chunk,encoding);}
return chunk;}
function doWrite(stream,state,writev,len,chunk,encoding,cb){state.writelen=len;state.writecb=cb;state.writing=true;state.sync=true;if(writev)
stream._writev(chunk,state.onwrite);else
stream._write(chunk,encoding,state.onwrite);state.sync=false;}
function onwrite(stream,er){var state=stream._writableState;var sync=state.sync;var cb=state.writecb;onwriteStateUpdate(state);if(er)
onwriteError(stream,state,sync,er,cb);else{var finished=needFinish(stream,state);if(!finished&&!state.corked&&!state.bufferProcessing&&state.buffer.length){clearBuffer(stream,state);}
if(sync){nextTick(function(){afterWrite(stream,state,finished,cb);});}else{afterWrite(stream,state,finished,cb);}}}
function afterWrite(stream,state,finished,cb){if(!finished)
onwriteDrain(stream,state);state.pendingcb--;cb();finishMaybe(stream,state);}
function onwriteStateUpdate(state){state.writing=false;state.writecb=null;state.length-=state.writelen;state.writelen=0;}
function onwriteStateUpdate(state){state.writing=false;state.writecb=null;state.length-=state.writelen;state.writelen=0;}
function needFinish(stream,state){return(state.ending&&state.length===0&&!state.finished&&!state.writing);}
function onwriteDrain(stream,state){if(state.length===0&&state.needDrain){state.needDrain=false;stream.emit('drain');}}
function finishMaybe(stream,state){var need=needFinish(stream,state);if(need){if(state.pendingcb===0){prefinish(stream,state);state.finished=true;stream.emit('finish');}else
prefinish(stream,state);}
return need;}
stream.Duplex=stream.Readable.extend({constructor:function(options){extend(this,new stream.Readable());extend(this,new stream.Writable());this.allowHalfOpen=true&&(!options||options.allowHalfOpen);this.once("end",function(){if(this.allowHalfOpen||this._writableState.ended)return;nextTick(this.end.bind(this));});}});CS.keys(stream.Writable.prototype).forEach(function(method){if(!stream.Duplex.prototype[method])stream.Duplex.prototype[method]=stream.Writable.prototype[method];});function TransformState(options,stream){this.afterTransform=function(er,data){return afterTransform(stream,er,data);};this.needTransform=false;this.transforming=false;this.writecb=null;this.writechunk=null;}
function afterTransform(stream,er,data){var ts=stream._transformState;ts.transforming=false;var cb=ts.writecb;if(!cb)return stream.emit('error',new Error('no writecb in Transform class'));ts.writechunk=null;ts.writecb=null;if(!CS.isNullOrUndefined(data))
stream.push(data);if(cb)cb(er);var rs=stream._readableState;rs.reading=false;if(rs.needReadable||rs.length<rs.highWaterMark){stream._read(rs.highWaterMark);}}
stream.Transform=stream.Duplex.extend({constructor:function(options){this.__super__(options);this._transformState=new TransformState(options,this);var stream=this;this._readableState.needReadable=true;this._readableState.sync=false;this.once('prefinish',function(){if(CS.isFunction(this._flush))
this._flush(function(er){done(stream,er);});else
done(stream);});},push:function(chunk,encoding){this._transformState.needTransform=false;return this.__super__.prototype.push.call(this,chunk,encoding);},_transform:function(chunk,encoding,cb){throw new Error('AbstractBaseMethod Called');},_write:function(chunk,encoding,cb){var ts=this._transformState;ts.writecb=cb;ts.writechunk=chunk;ts.writeencoding=encoding;if(!ts.transforming){var rs=this._readableState;if(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)
this._read(rs.highWaterMark);}},_read:function(n){var ts=this._transformState;if(!CS.isNull(ts.writechunk)&&ts.writecb&&!ts.transforming){ts.transforming=true;this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform);}else{ts.needTransform=true;}}});function done(stream,er){if(er)return stream.emit('error',er);var ws=stream._writableState;var ts=stream._transformState;if(ws.length)
throw new Error('calling transform done when ws.length != 0');if(ts.transforming)
throw new Error('calling transform done when still transforming');return stream.push(null);}
exports.stream=stream;}
var DS={};DS.Model=CS.Events.extend({constructor:function(options){var _this=this;CS.each(this.schema,function(key,value){if(value.default){_this.set(key,value.default);}else if(options[key]){_this.set(key,options[key]);}else if(value.required){throw"Invalid Create Operation";}else if(value.multiple){_this.set(key,[]);}});},get:function(key){return this.data[key];},set:function(key,value){if(this.schema[key].multiple&&!CS.isArray(value))throw"Invalid Set Operation";else if(CS["is"+this.schema[key].type](value))throw"Invalid Set Operation";else this._data[key]=value;this.emit("change");}});DS.Collection=CS.Events.extend({constuctor:function(options){this.model=options.model;this.backend=options.backend;},backend:function(eventName,obj,obj2){if(eventName==="schema"){this.data=[];}else if(eventName==="create"){this.data.push(obj);}else if(eventName==="delete"){for(var i=0;i<this.data.length;i++){if(val.id===obj)delete this.data[i];}}else if(eventName==="update"){this.data.forEach(function(val){if(val.id===obj){extend(val,obj2);return;}});}},find:function(criteria,cb){var _this=this;if(CS.isString(criteria)){this.backend("pinpoint",criteria,function(doc){var x=new _this.model(doc);x.on("change",function(){_this.update({_id:this.id()},this.toObject());});cb(x);});}else{this.backend("find",criteria,function(docs){docs.forEach(function(doc){var x=new _this.model(doc);x.on("change",function(){_this.update({_id:this.id()},this.toObject());});});});}},create:function(obj){return this.backend("create",new this.model(obj));},delete:function(criteria){return this.backend("delete",criteria);},update:function(criteria,obj){return this.backend("update",criteria,obj);}});DS.mongoDb=CS.Events.extend({constructor:function(url,onconnect){if(onconnect)this.on("connect",onconnect);var _this=this;this.db=mongodb.MongoClient.connect(url,function(err,db){_this.emit("connect");});},ls:function(cb){return this.db.collectionNames(cb);},delete:function(collection){return this.db.dropCollection(collection);},close:function(){this.db.close();}});var ES={};extend(ES,{clone:function(el){return el.cloneNode(true);},wrap:function(wrapper,el){var parent=el.parentNode;wrapper.appendChild(el);parent.appendChild(wrapper);},clear:function(el){el.innerHTML="";},prepend:function(parent,child){console.log(child);if(parent.firstChild)return parent.insertBefore(child,parent.firstChild);else return parent.appendChild(child);},append:function(parent,child){if(typeof child==="string")child=document.createTextNode(child);return parent.appendChild(child);},insertBefore:function(hook,el){hook.parentNode.insertBefore(el,hook);},insertAfter:function(hook,el){hook.parentNode.insertAfter(el,hook);},scrollTo:function(el){el.scrollIntoView();},getDocHeight:function(){var d=document;return Math.max(Math.max(d.body.scrollHeight,d.documentElement.scrollHeight),Math.max(d.body.offsetHeight,d.documentElement.offsetHeight),Math.max(d.body.clientHeight,d.documentElement.clientHeight));}});ES.Controller=CS.Events.extend({constructor:function(el){if(el){this.el=el;this.id=this.el.id;}
for(var e in this.events){var m=e.split(" ");if(m.length===1){this.el.addEventListener(e,this[this.events[e]].bind(this),false);}else{var n=m.slice(0,m.length-1);var o=m[m.length-1];var els=this.el.querySelectorAll(n.join(" "));for(var i=0;i<els.length;i++){els[i].addEventListener(o,this[this.events[e]].bind(this),false);}}}},find:function(selector){return this.el.querySelector(selector);}});if(fs!==undefined){FS.ls=function(dirname){var Stream=stream.Readable({objectMode:true});Stream._read=function(size){fs.readdir(dirname,function(err,list){Stream.push(list);Stream.emit("end");});};return Stream;};FS.cat=fs.createReadStream;FS.write=function(data,location){data.pipe(fs.createWriteStream(location));};}else{var URL=(root.URL||root.webkitURL);var saveAs=root.saveAs||root.navigator.msSaveOrOpenBlob||function(blob,filename){var privateUrl=URL.createObjectURL(blob);var x=document.createElement("a");x.href=privateUrl;x.download=filename;x.click();};FS.save=function(val,filename,type){if(type===undefined&&CS.isCanvas(val))text="image/png";else if(type===undefined)type="text/plain";if(CS.isBlob(val)){saveAs(val,filename);}else if(CS.isCanvas(val)){if(val.toBlob){val.toBlob(function(val){FS.save(val,filename);},type);}else if(val.mozGetAsFile){FS.save(val.mozGetAsFile("canvas",type),filename);}}else if(CS.isString(val)){FS.save([val],filename,type);}else if(CS.isArray(val)){FS.save(new Blob(val,{type:type}));}};}
var TS={};TS.Connection=function(data,options){this.__super__();options=extend({headers:{},ajax:true},options);if(options===undefined){options=data;data=null;}
if(options.username&&options.password){options.auth=options.username+":"+options.password;}
if(options.json){options.headers.Accept="application/json";}
if(options.ajax){options.headers["X-Requested-With"]="XMLHttpRequest";}
if(typeof url!==undefined&&options.url){options=merge(url.parse(options.url),options);}
if(!CS.isString(options.data)&&!CS.isUndefined(options.data)){options.data=JSON.stringify(options.data);options.headers["Content-Type"]="application/json";}
var _this=this;if(typeof http!==undefined&&http.request){this.out=http.request(options,function(input){_this.stdin=input;});}else{this.stdin=new stream.Readable();this.stdout=new stream.Writable();this.xmlhttp=new(root.XMLHttpRequest||(root.ActiveXObject&&ActiveXObject("Microsoft.XMLHTTP")));this.xmlhttp.open(options.method,options.url,true,options.username,options.password);this.xmlhttp.onreadystatechange=(function(chunk){if(xmlhttp.readyState===3){_this.stdout.push(chunk);}else if(xmlhttp.readyState===4){var call=(200>=xmlhttp.status&&xmlhttp.status<=226)?"end":"error";this.stdout.emit(call,xmlhttp.responseText||xmlhttp.responseXML,xmlhttp.status);}}).bind(this);CS.each(options.headers,(function(key,value){this.xmlhttp.setRequestHeader(key,value);}).bind(this));xmlhttp.send(options.data||"");}};CS.each("get post put delete connect".split(" "),function(method,i){TS[method]=function(url,data,options){var Connection=new TS.Connection(extend({url:url,method:method},options));Connection.out.write(data);Connection.out.emit("end");return Connection.in;};});TS.Controller=CS.Events.extend({constructor:function(req,res){console.log("BROOM UNUS");if(req){req.extension=req.path.split("/").slice(req.before.split("/").length).join("/");}
if(res){this.out=res;}
console.log(typeof req);console.log(typeof res);if(req&&res){console.log("BRROM DUO");if(this.static){var _this=this;fs.exists(path.join(_this.static,req.extension),function(exists){if(exists){fs.stat(path.join(_this.static,req.extension),function(err,stat){if(stat.isFile()){_this.out.render(path.join(_this.static,req.extension));}else{_this.handle(req);}});}else{_this.handle(req);}});}else{console.log("BROOM TRES");this.handle(req);}}},authenticate:function(req,cb){if(req.session.user&&req.extension==="logout"){delete req.session.user;}else if(!this.passport||req.session.user){return cb(req);}
if(req.extension==="login"){if(req.method==="POST"){var self=this;var obj=Object.create({success:function(user,info){req.session.user=user;self.index(req);},fail:function(user,info){self.login(req,info);}});var strategy=Object.create(this.passport);for(var x in obj){strategy[x]=obj[x].bind(this);}
strategy.authenticate(req);}else{this.login(req);}}else{this.illicit();}},handle:function(req){var self=this;this.authenticate(req,function(){var route=TS.pathToRegexp(req.before+"/"+"$",req.keys);if(route.test(req.path)){req.params=CS.object(req.keys,route.exec(req.path));if(req.method==="GET"&&self.index){self.index(req);return;}else if(req.method==="POST"&&self.create){self.create(req);return;}}
var xavier=false;CS.each(self.subs,function(key,value){if(TS.pathToRegexp(req.before+"/"+key,req.keys).test(req.path)){req.before+="/"+key;new value(req,self.out);xavier=true;}});if(xavier)return;self.cannotBeFound();});},permissionDenied:function(){this.out.writeHead(403);this.out.end();},cannotBeFound:function(){this.out.writeHead(404);this.out.end();},serverError:function(){this.out.writeHead(501);this.out.end();}});TS.Resource=TS.Controller.extend({handle:function(req){var self=this;console.log("BROOM QUINZE");this.authenticate(req,function(){console.log("BROOM QUINQUE");var route=TS.pathToRegexp(req.before+"/",req.keys,{absolute:true});if(route.test(req.path)){req.params=CS.object(req.keys,route.exec(req.path));if(req.method==="GET"&&self.index){self.index(req);return;}else if(req.method==="POST"&&self.create){self.create(req);return;}}
console.log(req.before+"/:"+self.name);route=TS.pathToRegexp(req.before+"/:"+self.name,req.keys,{absolute:true});console.log(route.test(req.path));console.log("BROOM SEX");if(route.test(req.path)){console.log("BROOM SEPTEM");req.params=CS.object(req.keys,route.exec(req.path));req.id=CS.last(route.exec(req.path));if(req.method==="GET"&&self.get){console.log("BROOM OCTO");console.log(self.out.headersSent);self.get(req);return;}else if(req.method==="PUT"&&self.update){self.update(req);return;}else if(req.method==="DELETE"&&self.del){self.del(req);return;}}
CS.each(self.subs,function(key,value){if(TS.pathToRegexp(req.before+"/:"+self.name+"/"+key,req.keys).test(req.url)){req.before+="/:"+self.name+"/"+key;new value(req,self.out);return;}});self.cannotBeFound();});}});TS.parseSignedCookies=function(obj,secret){var ret={};Object.keys(obj).forEach(function(key){var val=obj[key];if(val.indexOf('s:')===0){val=signature.unsign(val.slice(2),secret);if(val){ret[key]=val;delete obj[key];}}});return ret;};TS.parseSignedCookie=function(str,secret){console.log(str.slice(3));return str.indexOf('s:')===0?signature.unsign(str.slice(3),secret):str;};TS.parseJSONCookies=function(obj){Object.keys(obj).forEach(function(key){var val=obj[key];var res=exports.parseJSONCookie(val);if(res)obj[key]=res;});return obj;};TS.parseJSONCookie=function(str){if(str.indexOf('j:')===0){try{return JSON.parse(str.slice(2));}catch(err){}}};TS.pathToRegexp=function(path,keys,options){options=options||{};var sensitive=options.sensitive;var strict=options.strict;keys=keys||[];if(path instanceof RegExp)return path;if(path instanceof Array)path='('+path.join('|')+')';path=path.concat(strict?'':'/?').replace(/\/\(/g,'(?:/').replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(_,slash,format,key,capture,optional,star){keys.push({name:key,optional:!!optional});slash=slash||'';return''
+(optional?'':slash)
+'(?:'
+(optional?slash:'')
+(format||'')+(capture||(format&&'([^/.]+?)'||'([^/]+?)'))+')'
+(optional||'')
+(star?'(/*)?':'');}).replace(/([\/.])/g,'\\$1').replace(/\*/g,'(.*)');if(options.absolute)return new RegExp('^'+path+"$",sensitive?'':'i');else return new RegExp('^'+path,sensitive?'':'i');};TS.Controller.listen=function(port,options){var _this=this;var server=http.createServer();server.on("request",function(req,res){if(!req.cookies){var cookies=req.headers.cookie;req.secret=options.secret;req.cookies={};res.signedCookies={};if(cookies){try{req.cookies=cookie.parse(cookies);if(secret){req.signedCookies=TS.parseSignedCookies(req.cookies,options.secret);req.signedCookies=TS.parseJSONCookies(req.cookies,options.secret);}
req.cookies=TS.parseJSONCookies(req.cookies);}catch(err){err.status=400;}}}
if(options.session){var secret=options.session.secret||req.secret;if(!secret)throw"There needs to be a secret for sessions to actually work";var key=options.session.key||"connect.sess";req.session={};if(!options.session.secret){req.session=(options.session.key&&req.signedCookies[options.session.key])||{};}else{var rawCookie=req.cookies[key];if(rawCookie){var unsigned=TS.parseSignedCookie(rawCookie,secret);if(unsigned){var originalHash=crc32.signed(unsigned);req.session=TS.parseJSONCookie(unsigned)||{};}}}}
res.setHeader=function(key,value){if(this._headers&&key.toLowerCase()==="set-cookie"){var prev=this.getHeader(key);if(prev){if(CS.isArray(prev)){value=prev.concat(value);}else if(CS.isArray(value)){value=value.concat(prev);}else{value=[prev,value];}}}else if(this.charset&&key.toLowerCase()==="content-type"){value+='; charset='+this.charset;}
return http.ServerResponse.prototype.setHeader.call(this,key,value);};res.writeHead=function(statusCode,reasonPhrase,headers){if(CS.isObject(reasonPhrase))headers=reasonPhrase;if(CS.isObject(headers))CS.each(headers,this.setHeader.bind(this));this.emit("header");return http.ServerResponse.prototype.writeHead.call(this,statusCode,reasonPhrase);};res.render=function(filename,vars){if(CS.isString(filename)){this.setHeader("Content-Type",mime.lookup(filename));fs.createReadStream(filename).pipe(this);}else{this.setHeader("Content-Type","text/html");this.write(filename(extend(vars||{},req.session)));this.end();}};res.once("header",function(){if(!req.session){if(!options.session.expires)options.session.expires=new Date(0);var biscuits=[];CS.each(req.cookies,function(key,value){biscuits.push(cookie.serialize(key,value,options.session));});res.setHeader("Set-Cookie",biscuits.join(";"));}else{var value="j: "+JSON.stringify(req.session);if(originalHash===crc32.signed(value))return;value="s: "+signature.sign(value,options.session.secret);value=cookie.serialize(key,value,options.session);res.setHeader("Set-Cookie",value);}});var uri=url.parse(req.url,true);req.path=decodeURIComponent(uri.pathname);req.href=uri.href;req.search=uri.search;req.keys=[];req.before="";if(req.method==="POST"||req.method==="PUT"||req.method==="PATCH"||req.method==="DELETE"){var form=new formidable.IncomingForm();form.parse(req,function(err,fields,files){req.query=fields;req.files=files;new _this(req,res);});}else{req.query=uri.query;new _this(req,res);}});server.listen(port,function(){console.log("TS.Controller listening at "+port+".");});};exports.CS=CS;exports.DS=DS;exports.ES=ES;exports.FS=FS;exports.TS=TS;})();